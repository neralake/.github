name: Enforce Shortcut Ticket
on:
  workflow_call:
    secrets:
      SHORTCUT_API_TOKEN:
        required: true

jobs:
  validate-ticket-existence:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Shortcut Ticket Existsname: Enforce Shortcut Ticket
on:
  workflow_call:
    secrets:
      SHORTCUT_API_TOKEN:
        required: true

jobs:
  validate-ticket-existence:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Shortcut Ticket Exists
        uses: actions/github-script@v7
        env:
          SHORTCUT_TOKEN: ${{ secrets.SHORTCUT_API_TOKEN }}
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // 1. DEFINE REGEX
            // Group 1: story/123 or epic/123
            // Group 2: sc-123 or ch-123
            // Group 3: 123/ (at start of string only)
            const idRegex = /(?:story|epic)\/(\d+)|(?:sc|ch)-(\d+)|^(\d+)\//i;
            
            let ticketId = null;

            // 2. PRIORITY CHECK: Branch Name
            const branchMatch = pr.head.ref.match(idRegex);
            
            if (branchMatch) {
              // Check all 3 capture groups
              ticketId = branchMatch[1] || branchMatch[2] || branchMatch[3];
              console.log(`üîç Found Ticket ID in Branch Name: ${ticketId}`);
            } 
            // 3. SECONDARY CHECK: PR Title & Description
            else {
              console.log("‚ÑπÔ∏è No ID found in branch name. Checking PR description and title...");
              const textContext = `${pr.title} ${pr.body || ''}`;
              const textMatch = textContext.match(idRegex);
              
              if (textMatch) {
                ticketId = textMatch[1] || textMatch[2] || textMatch[3];
                console.log(`üîç Found Ticket ID in PR Description/Title: ${ticketId}`);
              }
            }

            // If still no ID found, fail the workflow
            if (!ticketId) {
              core.setFailed("‚ùå Blocking Merge: No Shortcut ticket ID found. Check branch name (e.g. '123/feature'), or PR body (e.g. 'sc-123').");
              return;
            }

            console.log(`Verifying existence of Ticket ID: ${ticketId}...`);

            // 4. CALL SHORTCUT API
            const response = await fetch(`https://api.app.shortcut.com/api/v3/stories/${ticketId}`, {
              method: 'GET',
              headers: {
                'Shortcut-Token': process.env.SHORTCUT_TOKEN,
                'Content-Type': 'application/json'
              }
            });

            // 5. VALIDATE RESPONSE
            if (response.status === 200) {
              const data = await response.json();
              console.log(`‚úÖ Success! Linked to valid story: "${data.name}"`);
              return; // Pass
            } else if (response.status === 404) {
              core.setFailed(`‚ùå Blocking Merge: Ticket ID ${ticketId} was found, but it does not exist in Shortcut (404). Check for typos.`);
            } else {
              console.warn(`‚ö†Ô∏è Could not verify ticket (API Status: ${response.status}). Allowing to proceed to avoid blocking work due to API errors.`);
            }
        uses: actions/github-script@v7
        env:
          SHORTCUT_TOKEN: ${{ secrets.SHORTCUT_API_TOKEN }}
        with:
          script: |
            const pr = context.payload.pull_request;
            const combinedContext = `${pr.title} ${pr.body} ${pr.head.ref}`;
            
            // 1. EXTRACT THE ID
            // Looks for "story/123", "epic/123", "sc-123", or "ch-123"
            // Returns the digits only (e.g. "556")
            const idRegex = /(?:story|epic)\/(\d+)|(?:sc|ch)-(\d+)/i;
            const match = combinedContext.match(idRegex);

            if (!match) {
              core.setFailed("‚ùå Blocking Merge: No Shortcut ticket ID found. Please include 'sc-123' or a Shortcut URL.");
              return;
            }

            // Capture the ID from either capture group 1 (URL) or 2 (Shortcode)
            const ticketId = match[1] || match[2];
            console.log(`üîç Found Ticket ID: ${ticketId}. Verifying existence...`);

            // 2. CALL SHORTCUT API
            // We use fetch (built into node 18+ actions) to hit the Shortcut API
            const response = await fetch(`https://api.app.shortcut.com/api/v3/stories/${ticketId}`, {
              method: 'GET',
              headers: {
                'Shortcut-Token': process.env.SHORTCUT_TOKEN,
                'Content-Type': 'application/json'
              }
            });

            // 3. VALIDATE RESPONSE
            if (response.status === 200) {
              const data = await response.json();
              console.log(`‚úÖ Success! Linked to valid story: "${data.name}"`);
              return; // Pass
            } else if (response.status === 404) {
              core.setFailed(`‚ùå Blocking Merge: Ticket ID ${ticketId} was found, but it does not exist in Shortcut (404). Check for typos.`);
            } else {
              // Handle 401 (Bad Token) or 429 (Rate Limit) gracefully
              console.warn(`‚ö†Ô∏è Could not verify ticket (API Status: ${response.status}). allowing to proceed to avoid blocking work due to API errors.`);
            }
